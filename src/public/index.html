<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Tank Dashboard MVP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDaXSoK-VMwnAj5X0e_FOG826ABBagVfLE",
      authDomain: "yasha-tank-controller.firebaseapp.com",
      databaseURL: "https://yasha-tank-controller-default-rtdb.firebaseio.com",
      projectId: "yasha-tank-controller",
      storageBucket: "yasha-tank-controller.firebasestorage.app",
      messagingSenderId: "446410548277",
      appId: "1:446410548277:web:3549ce197d78fc97e47d7c",
      measurementId: "G-37830TEG5L"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --------------------------
    // Auth
    // --------------------------
    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        document.getElementById("authStatus").textContent = "âŒ Login failed";
        alert(err.message);
      }
    }
    async function logout() {
      await signOut(auth);
    }

    // Update UI based on auth state
    onAuthStateChanged(auth, user => {
      const loginCard = document.getElementById("loginCard");
      const dashboard = document.getElementById("dashboard");
      const statusCorner = document.getElementById("statusCorner");

      if (user) {
        loginCard.classList.add("hidden");
        dashboard.classList.remove("hidden");
        statusCorner.textContent = `âœ… Logged in as ${user.email}`;

        // Load devices after login
        loadDevice("heatLamp");
        loadDevice("lights");
        loadDevice("camera");
      } else {
        loginCard.classList.remove("hidden");
        dashboard.classList.add("hidden");
        statusCorner.textContent = "ğŸ”’ Logged out";
      }
    });

    // --------------------------
    // Device logic
    // --------------------------
    function loadDevice(deviceId) {
      const desiredRef = ref(db, "devices/" + deviceId + "/desired");
      const reportedRef = ref(db, "devices/" + deviceId + "/reported");

      // Desired listener
      onValue(desiredRef, snap => {
        const data = snap.val() || {};
        document.querySelector(`#${deviceId} .desired`).textContent = JSON.stringify(data);
      });

      // Reported listener
      onValue(reportedRef, snap => {
        const data = snap.val() || {};
        document.querySelector(`#${deviceId} .reported`).textContent = JSON.stringify(data);
      });
    }

    function sendCommand(deviceId, newDesired) {
      set(ref(db, "devices/" + deviceId + "/desired"), newDesired);
    }

    // Expose to HTML
    window.login = login;
    window.logout = logout;
    window.sendCommand = sendCommand;
  </script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6 relative">
  <h1 class="text-3xl font-bold mb-4">ğŸ¦ Tank Dashboard</h1>

  <!-- Status Corner -->
  <div id="statusCorner" class="absolute top-4 right-4 text-sm text-gray-700">ğŸ”’ Logged out</div>

  <!-- Auth -->
  <div id="loginCard" class="bg-white shadow p-4 rounded-lg w-full max-w-md mb-6">
    <h2 class="text-xl font-semibold mb-2">Login</h2>
    <input id="email" type="email" placeholder="Email" class="w-full border rounded p-2 mb-2" />
    <input id="password" type="password" placeholder="Password" class="w-full border rounded p-2 mb-2" />
    <div class="flex gap-2">
      <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded">Login</button>
      <button onclick="logout()" class="bg-gray-500 text-white px-4 py-2 rounded">Logout</button>
    </div>
    <p id="authStatus" class="mt-2 text-sm text-gray-600">ğŸ”’ Not logged in</p>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full max-w-5xl hidden">

    <!-- Heat Lamp -->
    <div id="heatLamp" class="bg-white shadow p-4 rounded-lg">
      <h3 class="text-lg font-bold mb-2">ğŸ”¥ Heat Lamp</h3>
      <p><b>Desired:</b> <span class="desired">{}</span></p>
      <p><b>Reported:</b> <span class="reported">{}</span></p>
      <label class="flex items-center mt-2">
        <input type="checkbox" id="heatLampToggle" class="mr-2">
        <span>On</span>
      </label>
      <button onclick="sendCommand('heatLamp', {on: document.getElementById('heatLampToggle').checked})"
        class="mt-2 bg-green-500 text-white px-3 py-1 rounded">Update</button>
    </div>

    <!-- Lights -->
    <div id="lights" class="bg-white shadow p-4 rounded-lg">
      <h3 class="text-lg font-bold mb-2">ğŸ’¡ Lights</h3>
      <p><b>Desired:</b> <span class="desired">{}</span></p>
      <p><b>Reported:</b> <span class="reported">{}</span></p>
      <label class="flex items-center mt-2">
        <input type="checkbox" id="lightsToggle" class="mr-2">
        <span>On</span>
      </label>
      <button onclick="sendCommand('lights', {on: document.getElementById('lightsToggle').checked})"
        class="mt-2 bg-green-500 text-white px-3 py-1 rounded">Update</button>
    </div>

    <!-- Camera -->
    <div id="camera" class="bg-white shadow p-4 rounded-lg">
      <h3 class="text-lg font-bold mb-2">ğŸ“¸ Camera</h3>
      <p><b>Desired:</b> <span class="desired">{}</span></p>
      <p><b>Reported:</b> <span class="reported">{}</span></p>
      <label class="flex items-center mt-2">
        <input type="checkbox" id="cameraToggle" class="mr-2">
        <span>On</span>
      </label>
      <button onclick="sendCommand('camera', {on: document.getElementById('cameraToggle').checked})"
        class="mt-2 bg-green-500 text-white px-3 py-1 rounded">Update</button>
    </div>

    <!-- Video Stream -->
    <div id="videoCard" class="bg-white shadow p-4 rounded-lg col-span-1 md:col-span-3">
      <h3 class="text-lg font-bold mb-2">ğŸ“¹ Tank Camera</h3>
      <video id="tankStream" class="w-[640px] h-[320px] mx-auto rounded border" autoplay controls muted
        playsinline></video>

      <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
      <script>
        const video = document.getElementById("tankStream");
        const streamUrl = "https://books-gis-repeat-attorney.trycloudflare.com/stream.m3u8";

        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(streamUrl);
          hls.attachMedia(video);
          hls.on(Hls.Events.ERROR, function (event, data) {
            console.warn("HLS.js error:", data);
            if (data.fatal) {
              console.log("ğŸ”„ Reloading HLS stream...");
              hls.startLoad();
            }
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          // Safari native HLS support
          video.src = streamUrl;
          video.addEventListener("error", () => {
            console.log("ğŸ”„ Reloading stream for Safari...");
            video.load();
          });
        } else {
          video.outerHTML = "<p>âš ï¸ Your browser does not support HLS streaming.</p>";
        }
      </script>
    </div>


  </div>
</body>

</html>